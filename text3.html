<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Blockly Demo: Fixed Blockly</title>
  <script src="./blockly-master/blockly_compressed.js"></script>
  <script src="./blockly-master/blocks_compressed.js"></script>
  <script src="./blockly-master/msg/js/en.js"></script>
  <script src="./blockly-master/javascript_compressed.js"></script>  
  <style>
    body {
      background-color: #fff;
      font-family: sans-serif;
    }
    h1 {
      font-weight: normal;
      font-size: 140%;
    }
  </style>
</head>
<body>
  <div id="blocklyDiv" style="height: 580px; width: 600px;"></div>
  <div>
    <button id="gerateCode">生成代码</button> 
    <button id="runCode">执行代码</button> 
  </div>

  <xml id="toolbox" style="display: none">
    <category>
        <block type="controls_if"></block>
        <block type="logic_compare"></block>
        <block type="controls_repeat_ext"></block>
        <block type="math_number"></block>
        <block type="math_arithmetic"></block>
        <block type="text"></block>
        <block type="text_print"></block>
        <block type="string_length" custom="PROCEDURE"></block>
    </category>

    <category name="Colours" custom="COLOUR_PALETTE"></category>
  </xml>

  <script type="text/javascript">
    var code = "";
    document.getElementById("gerateCode").addEventListener("click",function(){
      console.info(".....代码如下....")
      code = Blockly.JavaScript.workspaceToCode(demoWorkspace);
      console.info(code)
    });

    document.getElementById("runCode").addEventListener("click",function(){
      console.info("执行代码如下....")
      try{
        eval(code)
      }
      catch(e){
        console.info("执行代码错误",e)
      }
    });
  </script>
  <script type="text/javascript">
    Blockly.Blocks['string_length'] = {
      init: function() {
        this.jsonInit({
          "message0": 'length of %1',
          "args0": [
            {
              "type": "input_value",
              "name": "VALUE",
              "check": "String"
            }
          ],
          "output": "Number",
          "colour": 280,
          "custom":"PROCEDURE",
          "tooltip": "Returns number of letters in the provided text.",
          "helpUrl": "http://www.w3schools.com/jsref/jsref_length_string.asp"
        });
      }
    };

    Blockly.JavaScript['string_length'] = function(block) {
      // String or array length.
      var argument0 = Blockly.JavaScript.valueToCode(block, 'VALUE',
          Blockly.JavaScript.ORDER_FUNCTION_CALL) || '\'\'';
      return [argument0 + '.length', Blockly.JavaScript.ORDER_MEMBER];
      // return "'aaa'.length";
    };




  </script>
  <script>

    myApplication.coloursFlyoutCallback = function(workspace) {
      // Returns an array of hex colours, e.g. ['#4286f4', '#ef0447']
      var colourList = myApplication.getPalette();
      var xmlList = [];
      if (Blockly.Blocks['colour_picker']) {
        for (var i = 0; i < colourList.length; i++) {
          var blockText = '<xml>' +
              '<block type="colour_picker">' +
              '<field name="COLOUR">' + colourList[i] + '</field>' +
              '</block>' +
              '</xml>';
          var block = Blockly.Xml.textToDom(blockText).firstChild;
          xmlList.push(block);
        }
      }
      return xmlList;
    };

    

    var demoWorkspace = Blockly.inject('blocklyDiv',
        {
          media: './blockly-master/media/',
         toolbox: document.getElementById('toolbox')
       });

  </script>
</body>
</html>